# 自定义变量

## 定义自定义变量

> 定义自定义变量必须使用@符号

```sql
SET @a = 1;
```

## 查看变量值

```sql
SELECT @a;
```

## 查询结果赋值给自定义变量

> 我们还可以将某个查询的结果赋值给一个变量，前提是这个查询的结果只有一个值.

```sql
SET @a = (SELECT m1 FROM t1 LIMIT 1);

SELECT n1 FROM t1 LIMIT 1 INTO @b;
```

# 存储函数

## 创建存储函数

> 存储函数其实就是一种函数，只不过在这个函数里可以执行 MySQL 的语句而已。它可以把处理某个问题的过程封装起来，之后我们直接调用函数就可以去解决这个问题了。

```sql
CREATE FUNCTION 存储函数名称([参数列表])
RETURNS 返回值类型
BEGIN
    函数体内容
END

eg:
CREATE FUNCTION avg_score(s VARCHAR(100))
  RETURNS DOUBLE
  BEGIN
    RETURN (SELECT AVG(score) FROM student_score WHERE stu_subject = s);
  END;
```

## 存储函数的调用

```sql
SELECT avg_score('母猪的产后护理');
```

## 查看和删除存储函数

# 查看

```sql
SHOW FUNCTION STATUS [LIKE 需要匹配的函数名]

SHOW CREATE FUNCTION 函数名
```

# 删除

```sql
DROP FUNCTION 函数名
```

## 函数体的定义

> 在函数体中定义局部变量

```sql
DECLARE 变量名1, 变量名2, ... 数据类型 [DEFAULT 默认值];

eg:
CREATE FUNCTION var_demo()
  RETURNS INT
  BEGIN
    DECLARE c INT;
    SET c = 5;
    RETURN c;
  END;

CREATE FUNCTION avg_score(s VARCHAR(100))
RETURNS DOUBLE
BEGIN
    DECLARE a DOUBLE;
    SET a = (SELECT AVG(score) FROM student_score WHERE subject = s);
    return a;
END;
```

> 在函数体中使用自定义变量

```sql
CREATE FUNCTION user_defined_var_demo()
  RETURNS INT
  BEGIN
    SET @abc = 10;
    return @abc;
  END;
```

> 判断语句的编写

```sql
IF 表达式 THEN
    处理语句列表
[ELSEIF 表达式 THEN
    处理语句列表]
... # 这里可以有多个ELSEIF语句
[ELSE
    处理语句列表]
END IF;

eg:
CREATE FUNCTION condition_demo(i INT)
  RETURNS VARCHAR(10)
  BEGIN
    DECLARE result VARCHAR(10);
    IF i = 1 THEN
      SET result = '结果是1';
    ELSEIF i = 2 THEN
      SET result = '结果是2';
    ELSEIF i = 3 THEN
      SET result = '结果是3';
    ELSE
      SET result = '非法参数';
    END IF;
    RETURN result;
  END;
```

> 循环语句的编写

- `WHILE` 循环

```sql
WHILE 表达式 DO
    处理语句列表
END WHILE;

eg:
CREATE FUNCTION sum_all(n INT UNSIGNED)
  RETURNS INT
  BEGIN
    DECLARE result INT DEFAULT 0;
    DECLARE i INT DEFAULT 1;
    WHILE i <= n DO
      SET result = result + i;
      SET i = i + 1;
    END WHILE;
    RETURN result;
  END;
```

- `REPEAT` 循环

```sql
REPEAT
    处理语句列表
UNTIL 表达式 END REPEAT;

eg:
CREATE FUNCTION sum_all(n INT UNSIGNED)
  RETURNS INT
  BEGIN
    DECLARE result INT DEFAULT 0;
    DECLARE i INT DEFAULT 1;
    REPEAT
        SET result = result + i;
        SET i = i + 1;
    UNTIL i > n END REPEAT;
    RETURN result;
  END;
```

- `LOOP` 循环

```sql
LOOP
    处理语句列表
END LOOP;

eg:
# 结束循环，并返回结果
CREATE FUNCTION sum_all(n INT UNSIGNED)
  RETURNS INT
  BEGIN
    DECLARE result INT DEFAULT 0;
    DECLARE i INT DEFAULT 1;
    LOOP
        IF i > n THEN
            RETURN result;
        END IF;
        SET result = result + i;
        SET i = i + 1;
    END LOOP;
  END;

# 结束循环，不返回结果
CREATE FUNCTION sum_all(n INT UNSIGNED)
  RETURNS INT
  BEGIN
    DECLARE result INT DEFAULT 0;
    DECLARE i INT DEFAULT 1;
    flag:LOOP
        IF i > n THEN
            LEAVE flag;
        END IF;
        SET result = result + i;
        SET i = i + 1;
    END LOOP flag;
    RETURN result;
  END;
```

# 存储过程

## 创建存储过程

> 存储函数和存储过程都属于存储例程，都是对某些语句的一个封装。存储函数侧重于执行这些语句并返回一个值，而存储过程更侧重于单纯的去执行这些语句。

```sql
CREATE PROCEDURE 存储过程名称([参数列表])
BEGIN
    需要执行的语句
END

eg:
CREATE PROCEDURE t1_operation(
  m1_value INT,
  n1_value CHAR(1)
)
  BEGIN
  SELECT * FROM t1;
  INSERT INTO t1(m1, n1) VALUES(m1_value, n1_value);
  SELECT * FROM t1;
  END;
```
